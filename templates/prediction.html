{% extends 'base.html' %}
{% block title %} Sunset Prediction {% endblock %}
{% block style %}

<style type="text/css">

    #map {
        height:600px;
        width:600px;

        
    }

    #col-content{
      padding-top: 100px;
    }

    .row {
      padding-top: 20px;
    }



</style>

{% endblock %}

{% block content %}

<input type='hidden' id='user_lat' value="{{ userLat }}">
<input type='hidden' id='user_lon' value="{{ userLon }}">

<input type='hidden' id='airport_lat' value="{{ airport_obj.lattitude }}">
<input type='hidden' id='airport_lng' value="{{ airport_obj.longitude }}">

<input type='hidden' id='rec_lat' value="{{ rec_lat }}">
<input type='hidden' id='rec_lng' value="{{ rec_lng }}">

<input type='hidden' id='sunset-time' value='{{ sunset_str }}'>
<input type='hidden' id='current-time' value='{{ current_time_str }}'>


<div class='container'>
  <div class = 'row'>
    <div class='col-xs-6' id="col-content">
      <h1> Here is my prediction: </h1>
      <p> (for {{ day }}'s sunset) </p>

      <h2> {{ description }} </h2>

      Local Timezone: {{local_tz}}<br>
      CURRENT TIME: {{local_time}}<br>
      <!-- <p id='current-time-display'> </p> -->
      SUNSET TIME ({{ day }}): {{local_sunset_time}} <br>
      <!-- <p id="sunset-time-display"> </p> -->
      <br><br><br>
      <p>Location of closest forecast: ({{ distance_to_closest }} km away) <br>
      {{ airport_obj.airport_name }}<br>
      {{ airport_obj.icao_code }}<br>
      </p>

      <p>
          <h3>{{rec_message}}</h3>
          {% if rec_forecast != 'same' %}
             ({{ distance_to_rec }} km away)<br>

             <h3>Forecast: {{rec_desc}}</h3>
          {% endif %}
      </p>
      <br>
      ranked recommendations:<br>
      {% for rating_dict in sorted_forecast_ratings %}
          {{ rating_dict['rank'] }} | {{ rating_dict['icao'] }}<br>
      {% endfor %}

    </div>  


    <div class='col-xs-6'>
      <div id='map'> 
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery.js"></script>



<script type="text/javascript">


// let sunsetTime = $('#sunset-time').val();
// let currentTime = $('#current-time').val();

// let sunsetTimeDisplay = $('#sunset-time-display');
// let currentTimeDisplay = $('#current-time-display');

// let sDate = new Date(sunsetTime);
// let cDate = new Date(currentTime);

// //TO DO:
// //Come back to this using a javascript library such as 'moments' to find the 
// //actual time zone instead of just stripping the string

// let sTimeZoneStr = sDate.toString()
// sTimeZoneStr = sTimeZoneStr.slice(sTimeZoneStr.length - 4, sTimeZoneStr.length - 1);
// let cTimeZoneStr = cDate.toString()
// cTimeZoneStr = cTimeZoneStr.slice(cTimeZoneStr.length - 4, cTimeZoneStr.length - 1);

// // let sDateTxt = sDate.getHours()+":"+sDate.getMinutes()+":"+sDate.getSeconds()+" "+"("+sTimeZoneStr+")";
// // let cDateTxt = cDate.getHours()+":"+cDate.getMinutes()+":"+cDate.getSeconds()+" "+"("+cTimeZoneStr+")";

// let sDateTimeStr = sDate.toLocaleTimeString() + " " + sTimeZoneStr;
// let cDateTimeStr = cDate.toLocaleTimeString() + " " + cTimeZoneStr;

// sunsetTimeDisplay.html(sDateTimeStr);
// currentTimeDisplay.html(cDateTimeStr);


function initMap() {
    let user_lat = parseFloat($('#user_lat').val())
    let user_lon = parseFloat($('#user_lon').val())

    let airportLat = parseFloat($('#airport_lat').val())
    let airportLng = parseFloat($('#airport_lng').val())

    let recLat = $('#rec_lat').val()
    let recLng = $('#rec_lng').val()

    let bounds;

    let yourPosition = {lat: user_lat, lng: user_lon};
        console.log(yourPosition)

    let airportPosition = {lat: airportLat, lng: airportLng}
        console.log(airportPosition)


    bounds = new google.maps.LatLngBounds();

    let map = new google.maps.Map(document.querySelector('#map'), {
        center: yourPosition
        // zoom: 11,
    });

    let marker = new google.maps.Marker({
        position: yourPosition,
        map: map,
        title: 'Chosen Location'
    });

    // let airportMarker = new google.maps.Marker({
    //     position: airportPosition,
    //     map: map,
    //     title: 'Forecast Location',
    //     // icon: 'http://boothamphitheatre.com/wp-content/uploads/2016/02/dc6o4KBc9.png'
    // });


    // let airportLoc = new google.maps.LatLng(airportMarker.position.lat(), airportMarker.position.lng());
    // bounds.extend(airportLoc);

    if (recLat !== 'None') {
        recLat = parseFloat(recLat)
        recLng = parseFloat(recLng)

        let recPosition = {lat: recLat, lng: recLng};

        let recMarker = new google.maps.Marker({
            position: recPosition,
            map: map,
            title: 'Recommended Location'
        });

        recLoc = new google.maps.LatLng(recMarker.position.lat(), recMarker.position.lng());
        bounds.extend(recLoc);
        
        let usrLoc = new google.maps.LatLng(marker.position.lat(), marker.position.lng());
        bounds.extend(usrLoc);
        map.fitBounds(bounds)
    }

    if (recLat == 'None'){
      map.setZoom(12);
    }

    
    initAutocomplete();
}



</script>
<script src="{{ mapsapiurl }}"
async defer></script>





{% endblock %}